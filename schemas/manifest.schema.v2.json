{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "TF_1 Export Manifest (v2) Snapshot",
  "type": "object",
  "$defs": {
    "kpi": {
      "type": "object",
      "description": "Metric summary with optional confidence interval bounds.",
      "required": ["value"],
      "properties": {
        "value": { "type": "number" },
        "lower_ci": { "type": "number" },
        "upper_ci": { "type": "number" },
        "sample_size": { "type": "integer", "minimum": 0 },
        "units": { "type": "string" }
      },
      "additionalProperties": false
    }
  },
  "required": [
    "schema_version",
    "model_name",
    "version",
    "created_utc",
    "framework",
    "input_signature",
    "label_space",
    "train_window",
    "metrics",
    "latency_metrics",
    "stability",
    "regime_metrics",
    "calibration",
    "data_hash",
    "dataset_version",
    "feature_hash",
    "scaler_refs"
  ],
  "properties": {
    "schema_version": { "const": "v2" },
    "model_name": { "type": "string", "minLength": 1 },
    "version": { "type": "string", "minLength": 1 },
    "created_utc": { "type": "string", "format": "date-time" },
    "framework": { "type": "string", "enum": ["tensorflow", "pytorch", "sklearn", "other"] },
    "code_commit": { "type": "string" },
    "dataset_version": { "type": "string", "minLength": 1 },
    "dataset_hash": { "type": "string" },
    "feature_set_version": { "type": "string" },
    "feature_hash": { "type": "string", "minLength": 8 },
    "label_schema_version": { "type": "string" },
    "input_signature": { "type": "object" },
    "label_space": { "type": "object" },
    "train_window": {
      "type": "object",
      "required": ["from_utc", "to_utc"],
      "properties": {
        "from_utc": { "type": "string", "format": "date-time" },
        "to_utc": { "type": "string", "format": "date-time" }
      },
      "additionalProperties": false
    },
    "metrics": {
      "type": "object",
      "description": "Aggregated evaluation KPIs for the promoted model.",
      "required": ["sharpe_sim", "max_drawdown_sim", "f1_macro", "minority_recall"],
      "properties": {
        "sharpe_sim": { "$ref": "#/$defs/kpi" },
        "max_drawdown_sim": { "$ref": "#/$defs/kpi" },
        "f1_macro": { "$ref": "#/$defs/kpi" },
        "minority_recall": { "$ref": "#/$defs/kpi" },
        "precision_macro": { "$ref": "#/$defs/kpi" },
        "recall_macro": { "$ref": "#/$defs/kpi" },
        "auc": { "$ref": "#/$defs/kpi" }
      },
      "additionalProperties": false
    },
    "latency_metrics": {
      "type": "object",
      "description": "Serving latency distribution in milliseconds.",
      "required": ["p50_ms", "p95_ms", "p99_ms", "max_ms"],
      "properties": {
        "p50_ms": { "$ref": "#/$defs/kpi" },
        "p95_ms": { "$ref": "#/$defs/kpi" },
        "p99_ms": { "$ref": "#/$defs/kpi" },
        "max_ms": { "$ref": "#/$defs/kpi" },
        "window": { "type": "string", "description": "Collection window identifier (e.g., 7d, validation)." }
      },
      "additionalProperties": false
    },
    "stability": {
      "type": "object",
      "description": "Stability diagnostics across regimes and time windows.",
      "required": ["variance", "max_regime_delta"],
      "properties": {
        "variance": { "$ref": "#/$defs/kpi" },
        "max_regime_delta": { "$ref": "#/$defs/kpi" },
        "rolling_sharpe_std": { "$ref": "#/$defs/kpi" },
        "notes": { "type": "string" }
      },
      "additionalProperties": false
    },
    "regime_metrics": {
      "type": "array",
      "description": "Per-regime performance snapshots using the same KPI schema.",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["regime", "metrics"],
        "properties": {
          "regime": { "type": "string", "minLength": 1 },
          "metrics": {
            "type": "object",
            "required": ["sharpe_sim", "f1_macro", "minority_recall"],
            "properties": {
              "sharpe_sim": { "$ref": "#/$defs/kpi" },
              "f1_macro": { "$ref": "#/$defs/kpi" },
              "minority_recall": { "$ref": "#/$defs/kpi" },
              "precision_macro": { "$ref": "#/$defs/kpi" },
              "sample_size": { "type": "integer", "minimum": 0 }
            },
            "additionalProperties": false
          }
        },
        "additionalProperties": false
      }
    },
    "calibration": {
      "type": "object",
      "description": "Calibration configuration and outcomes.",
      "required": ["method", "evaluated_at", "metrics"],
      "properties": {
        "method": { "type": "string", "enum": ["none", "temperature", "isotonic", "platt"] },
        "evaluated_at": { "type": "string", "format": "date-time" },
        "metrics": {
          "type": "object",
          "required": ["ece", "brier"],
          "properties": {
            "ece": { "$ref": "#/$defs/kpi" },
            "brier": { "$ref": "#/$defs/kpi" }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "data_hash": { "type": "string", "minLength": 8 },
    "scaler_refs": { "type": "object" },
    "wandb_run_id": { "type": "string" },
    "latency_notes": { "type": "string" },
    "export_manifest": {
      "type": "object",
      "properties": {
        "data_collection": {
          "type": "object",
          "properties": {
            "policy_version": { "type": "string" },
            "session_timezone": { "type": "string" },
            "l2_window": { "type": "string" },
            "bar_lookbacks": {
              "type": "object",
              "additionalProperties": { "type": "integer" }
            },
            "provider": { "type": "string" },
            "symbol_policy_version": { "type": "string" }
          },
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    }
  },
  "additionalProperties": true
}